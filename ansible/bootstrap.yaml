- hosts: all
  gather_facts: true

  tasks:
    - name: Install Python (for Ansible)
      raw: "apt-get -y -q install python"
      become: true
      retries: 3
      delay: 20
    - name: Ensure etcd dir is created
      file:
        path: /etc/etcd/
        recurse: yes
        state: directory
        owner: root
        group: root
      become: true
    - name: Copy TLS certificates
      copy:
        src: "../cert-authority/{{ item }}"
        dest: /etc/etcd/
        owner: root
        group: root
        mode: 0644
      with_items:
        - ca.pem
        - kubernetes-key.pem
        - kubernetes.pem
      become: true
    - name: Download and unzip etcd binaries
      unarchive:
        src: https://github.com/coreos/etcd/releases/download/v3.0.10/etcd-v3.0.10-linux-amd64.tar.gz
        dest: /tmp
        remote_src: True
    - name: Move etcd binaries to bin
      copy:
        src: "{{ item }}"
        dest: /usr/bin
        remote_src: True
        mode: 0755
      with_items:
        - /tmp/etcd-v3.0.10-linux-amd64/etcd
        - /tmp/etcd-v3.0.10-linux-amd64/etcdctl
      become: true
    - name: Copy etcd systemd unit template
      template:
        src: templates/etcd.service.j2
        dest: /etc/systemd/system/etcd.service
        owner: root
        group: root
        mode: 0644
      become: true
    - name: Enable etcd systemd unit
      systemd:
        state: restarted
        daemon_reload: yes
        enabled: yes
        name: etcd
      become: True
